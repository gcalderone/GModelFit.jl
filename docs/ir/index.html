<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Intrument response · GModelFit.jl</title><meta name="title" content="Intrument response · GModelFit.jl"/><meta property="og:title" content="Intrument response · GModelFit.jl"/><meta property="twitter:title" content="Intrument response · GModelFit.jl"/><meta name="description" content="Documentation for GModelFit.jl."/><meta property="og:description" content="Documentation for GModelFit.jl."/><meta property="twitter:description" content="Documentation for GModelFit.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">GModelFit.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../concepts/">Basic concepts and data types</a></li><li><a class="tocitem" href="../mainfunctions/">Main functionalities</a></li><li><a class="tocitem" href="../builtincomp/">Built-in components</a></li><li><a class="tocitem" href="../customcomp/">Custom components</a></li><li><a class="tocitem" href="../parameter/">Parameter constraints</a></li><li><a class="tocitem" href="../multifit/">Multi-dataset fitting</a></li><li class="is-active"><a class="tocitem" href>Intrument response</a><ul class="internal"><li><a class="tocitem" href="#Example"><span>Example</span></a></li></ul></li><li><a class="tocitem" href="../solvers/">Solvers</a></li><li><a class="tocitem" href="../misc/">Miscellaneous</a></li><li><a class="tocitem" href="../api/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Intrument response</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Intrument response</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/gcalderone/GModelFit.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/gcalderone/GModelFit.jl/blob/master/docs/src/ir.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Instrument-response"><a class="docs-heading-anchor" href="#Instrument-response">Instrument response</a><a id="Instrument-response-1"></a><a class="docs-heading-anchor-permalink" href="#Instrument-response" title="Permalink"></a></h1><p>An instrument response allows to convert the <em>unfolded</em> model into a form suitable to be compared with empirical data.  This may also involve a remapping from the unfolded model domain (namely, the domain where all model components are evaluated) to the folded model domain (namely, the domain where the measurements are evaluated).</p><p><strong>GModelFit.jl</strong> provides only one built-in instrument response named <code>GModelFit.IdealInstrument</code> representing an ideal instrument where the folded and unfolded models are identical.  No attempt is made to provide further instrument responses since these are strongly dependent on the instrument being used for the measurements.</p><p>It is however possible to implement a custom instrument responses as follows:</p><ul><li>Define a new structure inheriting from <code>GModelFit.AbstractInstrumentResponse</code>;</li><li>Optionally implement a <code>prepare!(::AbstractInstrumentResponse, ::AbstractDomain)</code> method aimed to pre-compute quantities to be used during model evaluation.  This step is not mandatory, and the default implementation for <code>prepare!</code> does nothing;</li><li>Implement an <code>unfolded_domain</code> method whose purpose is to return the domain for the <em>unfolded</em> model;</li><li>Implement an <code>apply_ir!</code> method whose purpose is to apply the instrument response on an unfolded model evaluation, and to populate the vector of the folded model;</li><li>Use <a href="../api/#GModelFit.set_IR!"><code>set_IR!</code></a> to select the proper instrument response.</li></ul><p>As an example we copy here the implementation for the <code>IdealInstrument</code>:</p><pre><code class="language-julia hljs"># Define IdealInstrument structure
struct IdealInstrument &lt;: AbstractInstrumentResponse
end

# Method to retrieve the unfolded model domain.  In this case it simply is the same as the folded domain.
unfolded_domain(IR::IdealInstrument, folded_domain::AbstractDomain) = folded_domain

# Method to apply the instrument response.  In this case it simply copies all values from the &quot;unfolded&quot;
# vector to the &quot;folded&quot; one.
function apply_ir!(IR::IdealInstrument,
                   folded_domain::AbstractDomain  , folded::Vector,
                   unfolded_domain::AbstractDomain, unfolded::Vector)
    folded .= unfolded
end</code></pre><h2 id="Example"><a class="docs-heading-anchor" href="#Example">Example</a><a id="Example-1"></a><a class="docs-heading-anchor-permalink" href="#Example" title="Permalink"></a></h2><p>A more complex example is as follows: suppose your instrument has a limited resolution and responds to a narrow signal by producing a rather broad feature in the data.  Also assume that your data are sampled on a non-regular grid, while you need to evaluate the unfolded model on a regular grid.</p><p>The following code shows how to implement an instrument response which:</p><ul><li>uses an evenly spaced grid for unfolded model evaluation;</li><li>convolve the unfolded model with a kernel representing the finite resolution of the instrument;</li><li>interpolate the evaluation onto the irregular grid where data are available.</li></ul><pre><code class="language-julia hljs">using GModelFit, Gnuplot, DSP, Interpolations

# Import relevant methods
import GModelFit: unfolded_domain, apply_ir!

# Create the new structure representing the instrument response
struct MyInstrument &lt;: GModelFit.AbstractInstrumentResponse
    kernel::Vector{Float64}
    function MyInstrument()
        # Convolution kernel representing the limited resolution of the instrument
        # (an ideal instrument would have kernel = [1])
        kernel = [0.0, 0.0, 0.0, 0.0, 0.002, 0.009, 0.027, 0.065, 0.121, 0.176, 0.199,
                  0.176, 0.121, 0.065, 0.027, 0.009, 0.002, 0.0, 0.0, 0.0, 0.0]
        return new(kernel)
    end
end

# Return the evenly-spaced domain to be used for evalation of the unfolded model
unfolded_domain(IR::MyInstrument, folded_domain::GModelFit.AbstractDomain) = Domain(4.5:0.1:6.5)

# Apply instrument response
function apply_ir!(IR::MyInstrument,
                   folded_domain::GModelFit.AbstractDomain, folded::Vector,
                   unfolded_domain::GModelFit.AbstractDomain, unfolded::Vector)
    # Convolve with instrument response
    d = div(length(IR.kernel)-1, 2)
    y = conv(unfolded, IR.kernel)[d+1:end-d]

    # Interpolate on the irregular grid of the folded domain
    folded .= linear_interpolation(coords(unfolded_domain), y)(coords(folded_domain))
end</code></pre><p>The code to use the above defined <code>MyInstrument</code> instrument response is as follows:</p><pre><code class="language-julia hljs"># Create empirical data structures
dom = Domain([4.898, 4.997, 5.054, 5.09, 5.142, 5.229, 5.239, 5.429, 5.592, 5.629, 5.829, 5.882, 5.946, 5.99, 6.181])
data = Measures(dom, [3.009, 3.017, 3.251, 3.209, 3.568, 4.118, 4.487, 4.837, 4.428, 4.396, 3.78, 3.443, 3.237, 3.28, 3.032], 0.12)

# Define a model and set MyInstrument as instrument response
model = Model(@fd (x, μ=5.5, σ=0.1, off=3) -&gt; (@. off + exp(-0.5 * ((x - μ) / σ)^2) / sqrt(2pi) / σ))
set_IR!(model, MyInstrument())

# Fit data to the model
bestfit, fsumm = fit(model, data)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">(<span class="sgr32"><span class="sgr1">Components:
</span></span><span class="sgr1"><span class="sgr94">╭</span></span><span class="sgr94">───────────┬───────┬───────┬─────────────┬───────────┬───────────┬───────────┬─────────╮</span>
<span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Component </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Type  </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> #Free </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Eval. count </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Min       </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Max       </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Mean      </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> NaN/Inf </span></span></span><span class="sgr94">│</span>
<span class="sgr94">├───────────┼───────┼───────┼─────────────┼───────────┼───────────┼───────────┼─────────┤</span>
<span class="sgr94">│</span> main      <span class="sgr94">│</span> FComp <span class="sgr94">│</span> 3     <span class="sgr94">│</span> 93          <span class="sgr94">│</span>     3.057 <span class="sgr94">│</span>     7.384 <span class="sgr94">│</span>     3.533 <span class="sgr94">│</span> 0       <span class="sgr94">│</span>
<span class="sgr94">╰───────────┴───────┴───────┴─────────────┴───────────┴───────────┴───────────┴─────────╯</span>

<span class="sgr32"><span class="sgr1">Parameters:
</span></span><span class="sgr1"><span class="sgr94">╭</span></span><span class="sgr94">───────────┬───────┬────────┬──────────┬───────────┬───────────┬────────┬───────╮</span>
<span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Component </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Type  </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Param. </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Range    </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Value     </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Uncert.   </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Actual </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Patch </span></span></span><span class="sgr94">│</span>
<span class="sgr94">├───────────┼───────┼────────┼──────────┼───────────┼───────────┼────────┼───────┤</span>
<span class="sgr94">│</span> main      <span class="sgr94">│</span> FComp <span class="sgr94">│</span> μ      <span class="sgr94">│</span> -Inf:Inf <span class="sgr94">│</span>      5.47 <span class="sgr94">│</span>   0.01569 <span class="sgr94">│</span>        <span class="sgr94">│</span>       <span class="sgr94">│</span>
<span class="sgr94">│</span>           <span class="sgr94">│</span>       <span class="sgr94">│</span> σ      <span class="sgr94">│</span> -Inf:Inf <span class="sgr94">│</span>   0.08669 <span class="sgr94">│</span>   0.03739 <span class="sgr94">│</span>        <span class="sgr94">│</span>       <span class="sgr94">│</span>
<span class="sgr94">│</span>           <span class="sgr94">│</span>       <span class="sgr94">│</span> off    <span class="sgr94">│</span> -Inf:Inf <span class="sgr94">│</span>     3.057 <span class="sgr94">│</span>   0.04929 <span class="sgr94">│</span>        <span class="sgr94">│</span>       <span class="sgr94">│</span>
<span class="sgr94">╰───────────┴───────┴────────┴──────────┴───────────┴───────────┴────────┴───────╯</span>
, <span class="sgr32"><span class="sgr1">Fit summary:</span></span><span class="sgr1"> #data: 15, #free pars: 3, red. fit stat.: 2.3376, status: <span class="sgr32">OK      </span>
)</span></code></pre><p>From the plot we can see that the feature in the data is broader than the actual feature in the unfolded model (identified by the <code>main</code> component):</p><pre><code class="language-julia hljs">@gp bestfit data</code></pre><p><img src="../assets/ir_example.png" alt/></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../multifit/">« Multi-dataset fitting</a><a class="docs-footer-nextpage" href="../solvers/">Solvers »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Friday 25 July 2025 08:16">Friday 25 July 2025</span>. Using Julia version 1.11.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
