<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Parameter constraints · Gfit.jl</title><script data-outdated-warner src="assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="assets/documenter.js"></script><script src="siteinfo.js"></script><script src="../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="index.html"><img src="assets/logo.png" alt="Gfit.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="index.html">Gfit.jl</a></span></div><form class="docs-search" action="search.html"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="index.html">Home</a></li><li><a class="tocitem" href="concepts.html">Basic concepts and data types</a></li><li><a class="tocitem" href="builtincomp.html">Built-in components</a></li><li><a class="tocitem" href="customcomp.html">Custom components</a></li><li class="is-active"><a class="tocitem" href="parameter.html">Parameter constraints</a></li><li><a class="tocitem" href="multifit.html">Multi-dataset fitting</a></li><li><a class="tocitem" href="minimizers.html">Minimizers</a></li><li><a class="tocitem" href="misc.html">Miscellaneous</a></li><li><a class="tocitem" href="api.html">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href="parameter.html">Parameter constraints</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="parameter.html">Parameter constraints</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/gcalderone/GFit.jl/blob/master/docs/src/parameter.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Parameter-constraints"><a class="docs-heading-anchor" href="#Parameter-constraints">Parameter constraints</a><a id="Parameter-constraints-1"></a><a class="docs-heading-anchor-permalink" href="#Parameter-constraints" title="Permalink"></a></h1><p>Models are characterized by <em>parameters</em> (see <a href="concepts.html#Basic-concepts-and-data-types">Basic concepts and data types</a>) whose values are modified during fitting until a convergence criterion is met, and the <em>best fit</em> values are identified.  In many cases, however, the parameters can not vary arbitrarily but should satisfy some constraints for their values to be meaningful.  <strong>GFit.jl</strong> supports the definition of constraints by fixing the parameter to a specific value, limiting the value in a user defined range, or by dynamically calculating its value using a mathematical expression involving other parameter values.  In the latter case the parameter is not free to vary in the fit since its actual value is determined by the patch constraint, hence it is dubbed a <em>patched</em> parameter.  Such unused parameter can optionally be repurposed as a new free parameter in a <em>parametrized patch expression</em> (see example below).</p><p>An important concept to bear in mind is that the <a href="api.html#GFit.Parameter"><code>GFit.Parameter</code></a> structure provides two field for the associated numerical value:</p><ul><li><code>val</code>: is the parameter value which is being varied by the minimizer during fitting.  The value set before the fitting is the <em>guess</em> value.  The value after fitting is the <em>best fit</em> one;</li><li><code>actual</code>: is the result of the patch expression evaluation, and the actual value used when evaluating a component.  Note that this value will be overwitten at each model evaluation, hence setting this field has no effect. The <code>val</code> and <code>actual</code> values are identical if no patch constraint has been defined.</li></ul><p>A parameter constraint is defined by explicitly modifiying the fields of the corresponding <a href="api.html#GFit.Parameter"><code>GFit.Parameter</code></a> structure. More specifically:</p><ol><li>to set a parameter to a specific value: set the <code>val</code> field to the numeric value and set the <code>fixed</code> field to <code>true</code>;</li><li>to set a parameter value range: set one or both the <code>low</code> and <code>high</code> fields (default values are <code>-Inf</code> and <code>+Inf</code> respectively);</li><li>to constraint a parameter to have the same numerical value as another one with the same name (but in another component): set the <code>patch</code> value to the component name (it must be a <code>Symbol</code>).  In this case the parameter is assumed to be fixed;</li><li>to dynamically calculate an <code>actual</code> value using a mathematical expression depending on other parameter values: set the <code>patch</code> field to a λ-function (generated with the <a href="api.html#GFit.@λ"><code>@λ</code></a> macro) which must accept a single argument (which can be used as a dictionary of components) and return a scalar number.  In this case the parameter is assumed to be fixed;</li><li>to define a parametrized patch expression: create a a λ-function with two arguments, the first has the same meaning as in the previous case, and the second is the free parameter value.  Note that patched parameter loses its original meaning, and becomes the parameter of the patch expression;</li><li>to define a patch constraint involving parameters from other models in a <a href="multifit.html#Multi-dataset-fitting">Multi-dataset fitting</a> scenario: simply use <code>mpatch</code> in place of <code>patch</code>, and the first argument to the λ-function will be a vector with as many elements as the number of models in the <code>Vector{Model}</code> object.</li></ol><p>The following examples show how to define constraints for each of the afore-mentioned cases.</p><h3 id="Example"><a class="docs-heading-anchor" href="#Example">Example</a><a id="Example-1"></a><a class="docs-heading-anchor-permalink" href="#Example" title="Permalink"></a></h3><p>We will consider a model for a 1D domain consisting of the sum of a linear background component (named <code>bkg</code>) and two Gaussian-shaped features (<code>l1</code> and <code>l2</code>):</p><pre><code class="language-julia hljs">using GFit

dom = Domain(0:0.1:5)
model = Model(dom, :bkg =&gt; GFit.OffsetSlope(1, 1, 0.1),
                   :l1 =&gt; GFit.Gaussian(1, 2, 0.2),
                   :l2 =&gt; GFit.Gaussian(1, 3, 0.4),
                   :main =&gt; SumReducer(:bkg, :l1, :l2))</code></pre><p>Assume that, for the model to be meaningful, the parameters should satisfy the following constraints:</p><ul><li>the <code>bkg</code> should have a fixed value of 1 at <code>x</code>=1, and a slope which is in the range [0:0.2]:</li></ul><pre><code class="language-julia hljs">model[:bkg].offset.val = 1
model[:bkg].offset.fixed = true

model[:bkg].slope.low  = 0
model[:bkg].slope.high = 0.2</code></pre><ul><li>the normalization of <code>l1</code> and <code>l2</code> must be the same:</li></ul><pre><code class="language-julia hljs">model[:l2].norm.patch = :l1</code></pre><ul><li>the width of <code>l2</code> must be twice that of <code>l1</code> (patched parameter):</li></ul><pre><code class="language-julia hljs">model[:l2].sigma.patch = @λ m -&gt; 2 * m[:l1].sigma</code></pre><ul><li>the center of <code>l2</code> must be at a larger coordinate with respect to the center of <code>l1</code>.  In this case we re-interpret the <code>model[:l2].center</code> parameter as the distance between the two centers, and create a parametrized patch expression to calculate the actual center value of <code>l2</code>:</li></ul><pre><code class="language-julia hljs">model[:l2].center.patch = @λ (m, v) -&gt; v + m[:l1].center
model[:l2].center.val = 1   # guess value for the distance between the centers
model[:l2].center.low = 0   # ensure [l2].center &gt; [l1].center</code></pre><p>We can fit the model against a mock dataset (see <a href="misc.html#Generate-mock-datasets">Generate mock datasets</a>):</p><pre><code class="language-julia hljs">data = GFit.mock(Measures, model)
best, fitstats = fit(model, data)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">(<span class="sgr32"><span class="sgr1">Components:</span></span><span class="sgr1">
<span class="sgr94">╭</span></span><span class="sgr94">───────────┬─────────────────────┬─────────────┬───────────┬───────────┬───────────┬─────────╮</span>
<span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Component </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Type                </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Eval. count </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Min       </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Max       </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Mean      </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> NaN/Inf </span></span></span><span class="sgr94">│</span>
<span class="sgr94">├───────────┼─────────────────────┼─────────────┼───────────┼───────────┼───────────┼─────────┤</span>
<span class="sgr94">│</span> main      <span class="sgr94">│</span> SumReducer          <span class="sgr94">│</span> 160         <span class="sgr94">│</span>    0.8985 <span class="sgr94">│</span>     3.049 <span class="sgr94">│</span>     1.535 <span class="sgr94">│</span> 0       <span class="sgr94">│</span>
<span class="sgr94">│</span>  ├─ bkg   <span class="sgr94">│</span> GFit.OffsetSlope_1D <span class="sgr94">│</span> 52          <span class="sgr94">│</span>    0.8985 <span class="sgr94">│</span>     1.406 <span class="sgr94">│</span>     1.152 <span class="sgr94">│</span> 0       <span class="sgr94">│</span>
<span class="sgr94">│</span>  ├─ l1    <span class="sgr94">│</span> GFit.Gaussian_1D    <span class="sgr94">│</span> 104         <span class="sgr94">│</span> 1.978e-47 <span class="sgr94">│</span>      1.91 <span class="sgr94">│</span>    0.1915 <span class="sgr94">│</span> 0       <span class="sgr94">│</span>
<span class="sgr94">│</span>  └─ l2    <span class="sgr94">│</span> GFit.Gaussian_1D    <span class="sgr94">│</span> 118         <span class="sgr94">│</span> 8.186e-13 <span class="sgr94">│</span>    0.9504 <span class="sgr94">│</span>    0.1915 <span class="sgr94">│</span> 0       <span class="sgr94">│</span>
<span class="sgr94">╰───────────┴─────────────────────┴─────────────┴───────────┴───────────┴───────────┴─────────╯</span>

<span class="sgr32"><span class="sgr1">Parameters:</span></span><span class="sgr1">
<span class="sgr94">╭</span></span><span class="sgr94">───────────┬────────┬───────┬───────────┬───────────┬───────────┬─────────────────────────────╮</span>
<span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Component </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Param. </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Range </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Value     </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Uncert.   </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Actual    </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Patch                       </span></span></span><span class="sgr94">│</span>
<span class="sgr94">├───────────┼────────┼───────┼───────────┼───────────┼───────────┼─────────────────────────────┤</span>
<span class="sgr94">│</span><span class="sgr90"> bkg       </span><span class="sgr94">│</span><span class="sgr90"> offset </span><span class="sgr94">│</span><span class="sgr90">       </span><span class="sgr94">│</span><span class="sgr90">         1 </span><span class="sgr94">│</span><span class="sgr90">  (FIXED)  </span><span class="sgr94">│</span><span class="sgr90">           </span><span class="sgr94">│</span><span class="sgr90">                             </span><span class="sgr94">│</span>
<span class="sgr94">│</span><span class="sgr90">           </span><span class="sgr94">│</span><span class="sgr90"> x0     </span><span class="sgr94">│</span><span class="sgr90">       </span><span class="sgr94">│</span><span class="sgr90">         1 </span><span class="sgr94">│</span><span class="sgr90">  (FIXED)  </span><span class="sgr94">│</span><span class="sgr90">           </span><span class="sgr94">│</span><span class="sgr90">                             </span><span class="sgr94">│</span>
<span class="sgr94">│</span>           <span class="sgr94">│</span> slope  <span class="sgr94">│</span> 0:0.2 <span class="sgr94">│</span>    0.1015 <span class="sgr94">│</span>   0.01196 <span class="sgr94">│</span>           <span class="sgr94">│</span>                             <span class="sgr94">│</span>
<span class="sgr94">├───────────┼────────┼───────┼───────────┼───────────┼───────────┼─────────────────────────────┤</span>
<span class="sgr94">│</span> l1        <span class="sgr94">│</span> norm   <span class="sgr94">│</span> 0:Inf <span class="sgr94">│</span>    0.9766 <span class="sgr94">│</span>   0.04445 <span class="sgr94">│</span>           <span class="sgr94">│</span>                             <span class="sgr94">│</span>
<span class="sgr94">│</span>           <span class="sgr94">│</span> center <span class="sgr94">│</span>       <span class="sgr94">│</span>         2 <span class="sgr94">│</span>   0.01318 <span class="sgr94">│</span>           <span class="sgr94">│</span>                             <span class="sgr94">│</span>
<span class="sgr94">│</span>           <span class="sgr94">│</span> sigma  <span class="sgr94">│</span> 0:Inf <span class="sgr94">│</span>     0.204 <span class="sgr94">│</span>  0.009711 <span class="sgr94">│</span>           <span class="sgr94">│</span>                             <span class="sgr94">│</span>
<span class="sgr94">├───────────┼────────┼───────┼───────────┼───────────┼───────────┼─────────────────────────────┤</span>
<span class="sgr94">│</span> l2        <span class="sgr94">│</span> norm   <span class="sgr94">│</span> 0:Inf <span class="sgr94">│</span>         1 <span class="sgr94">│</span>           <span class="sgr94">│</span>    0.9766 <span class="sgr94">│</span> l1                          <span class="sgr94">│</span>
<span class="sgr94">│</span>           <span class="sgr94">│</span> center <span class="sgr94">│</span> 0:Inf <span class="sgr94">│</span>     1.041 <span class="sgr94">│</span>   0.03761 <span class="sgr94">│</span>     3.041 <span class="sgr94">│</span> (m, v)-&gt;v + (m[:l1]).center <span class="sgr94">│</span>
<span class="sgr94">│</span>           <span class="sgr94">│</span> sigma  <span class="sgr94">│</span> 0:Inf <span class="sgr94">│</span>       0.4 <span class="sgr94">│</span>           <span class="sgr94">│</span>    0.4079 <span class="sgr94">│</span> m-&gt;2 * (m[:l1]).sigma       <span class="sgr94">│</span>
<span class="sgr94">╰───────────┴────────┴───────┴───────────┴───────────┴───────────┴─────────────────────────────╯</span>
, <span class="sgr32"><span class="sgr1">Fit results:</span></span><span class="sgr1">
    #Data :       51         Red. fit stat.:     1.4312  (DOF: 46)
    #Free :        5         Elapsed time  :      0.007 s
    Status: <span class="sgr32">      OK</span>
)</span></code></pre><p>and plot the results with <a href="https://github.com/gcalderone/Gnuplot.jl">Gnuplot.jl</a>:</p><pre><code class="language-julia hljs">using Gnuplot
@gp    coords(dom) values(data) uncerts(data) &quot;w yerr t &#39;Data&#39;&quot; :-
@gp :- coords(dom) model() &quot;w l t &#39;Model&#39;&quot;</code></pre><p><img src="assets/example_patch1.png" alt/></p><p>See <a href="multifit.html#Multi-dataset-fitting">Multi-dataset fitting</a> for an example on how to create a patch epression involving multiple models.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="customcomp.html">« Custom components</a><a class="docs-footer-nextpage" href="multifit.html">Multi-dataset fitting »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.24 on <span class="colophon-date" title="Sunday 5 March 2023 02:44">Sunday 5 March 2023</span>. Using Julia version 1.8.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
