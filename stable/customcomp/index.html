<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Custom components · GModelFit.jl</title><meta name="title" content="Custom components · GModelFit.jl"/><meta property="og:title" content="Custom components · GModelFit.jl"/><meta property="twitter:title" content="Custom components · GModelFit.jl"/><meta name="description" content="Documentation for GModelFit.jl."/><meta property="og:description" content="Documentation for GModelFit.jl."/><meta property="twitter:description" content="Documentation for GModelFit.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">GModelFit.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../concepts/">Basic concepts and data types</a></li><li><a class="tocitem" href="../builtincomp/">Built-in components</a></li><li class="is-active"><a class="tocitem" href>Custom components</a></li><li><a class="tocitem" href="../parameter/">Parameter constraints</a></li><li><a class="tocitem" href="../multifit/">Multi-dataset fitting</a></li><li><a class="tocitem" href="../minimizers/">Minimizers</a></li><li><a class="tocitem" href="../misc/">Miscellaneous</a></li><li><a class="tocitem" href="../api/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Custom components</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Custom components</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/gcalderone/GModelFit.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/gcalderone/GModelFit.jl/blob/master/docs/src/customcomp.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Custom-components"><a class="docs-heading-anchor" href="#Custom-components">Custom components</a><a id="Custom-components-1"></a><a class="docs-heading-anchor-permalink" href="#Custom-components" title="Permalink"></a></h1><p>Besides the <a href="../builtincomp/#Built-in-components">Built-in components</a>, the user may define any number of custom components to be used in a model.</p><p>A user-defined component shall satisfy the following constraints:</p><ul><li><p>it shall be defined as a structure inheriting <code>AbstractComponent</code>;</p></li><li><p>the structure fields shall contain the component parameters as <code>Parameter</code> object(s), e.g.:</p></li></ul><pre><code class="language-julia hljs">struct MyComponent &lt;: AbstractComponent
	param1::Parameter
	param2::Parameter
	...
end</code></pre><p>(see below for a complete example). Alternatively, the parameters may be specified as a single field of type <code>OrderedDict{Symbol, Parameter}</code> (see the <a href="https://github.com/gcalderone/GModelFit.jl/blob/master/src/components/Polynomial.jl"><code>Polynomial</code></a> component for an example);</p><ul><li>the <code>evaluate!</code> function shall be extended to provide the component-specific code for evaluation.</li></ul><p>Specifically, the <code>evaluate!</code> function should replace the content of a <code>buffer::Vector{Float64}</code> with the outcome of the new component evaluation, given the numerical values for the parameters, e.g.</p><pre><code class="language-julia hljs">function evaluate!(buffer::Vector{Float64}, comp::MyComponent, x::AbstractDomain,
                   param1::Float64, param2::Float64...)
	buffer .= (component evaluation using param1 and param2 values)
end</code></pre><p>Optionally, the user may chose to extend also the following functions:</p><ul><li><p><code>prepare!</code>: to prepare the component for evaluations on a specific domain (e.g. to pre-compute quantities which depend only on the domain being used). The return value must be the buffer (of type <code>Vector{Float64}</code>) to accomodate the component evaluation.  The default implementation simply creates a buffer with the same length as the input domain;</p></li><li><p><code>dependencies</code>: return a <code>Vector{Symbol}</code> specifying the names of the component dependencies.  The evaluation of the latter will be made available as arguments to the <code>evaluate!</code> method. The default implementation returns an empty list <code>Symbol[]</code>.</p></li></ul><h3 id="Life-cycle-of-a-component"><a class="docs-heading-anchor" href="#Life-cycle-of-a-component">Life cycle of a component</a><a id="Life-cycle-of-a-component-1"></a><a class="docs-heading-anchor-permalink" href="#Life-cycle-of-a-component" title="Permalink"></a></h3><p>All components &quot;live&quot; within <code>Model</code> object, which has a well defined domain associated (see constructor of <code>Model</code>).  The same domain will also be used for component evaluations.  The typical life cycle of a component is as follows:</p><ol><li>the component is created invoking its constructor and providing an initial guess values for all parameters;</li><li>the component is added to the model. In this step the <code>prepare!</code> function is called to precompute component quantities (according to the domain associated to the <code>Model</code> object) and to allocate the buffer for evaluations.  Note that the <code>prepare!</code> function is invoked only once for each component;</li><li>the user may optionally modify the component parameter guess values, as well as their <a href="../parameter/#Parameter-constraints">Parameter constraints</a>, before starting the fit;</li><li>before starting the fit process a dependency tree is generated to identify all component dependencies (by invoking the <code>dependencies()</code> function for all components). The tree is used to identify the proper order for component evaluations: the leaves will be evaluated first, and the remaining ones will be evaluated following the tree branches.  The evaluation of the last component (the root of the tree) will be compared to the data;</li><li>during the fitting process the component <code>evaluate!()</code> function is invoked whenever a change in its parameter values is detected, until a convergence criterion is satisfied.</li></ol><h3 id="Example"><a class="docs-heading-anchor" href="#Example">Example</a><a id="Example-1"></a><a class="docs-heading-anchor-permalink" href="#Example" title="Permalink"></a></h3><p>A common case is to compare empirical data with a numerically evaluated theoretical model, possibly defined on a different grid with respect to the empirical one.  An interpolation is therefore required in order to compare the model to the data.</p><p>Let&#39;s assume the theoretical model is defined as follows:</p><pre><code class="language-julia hljs">theory_x = 0.:10
theory_y = [0, 0.841, 0.909, 0.141, -0.757, -0.959, -0.279, 0.657, 0.989, 0.412, -0.544]</code></pre><p>while the empirical data are:</p><pre><code class="language-julia hljs">obs_x = [0.500, 2.071, 3.642, 5.212, 6.783, 8.354, 9.925]
obs_y = [2.048, 3.481, 1.060, 0.515, 3.220, 4.398, 1.808]</code></pre><p>The following example shows how to implement a component aimed to interpolate the theoretical model onto a specific empirical domain, with the only parameter being a global scaling factor:</p><pre><code class="language-julia hljs">using GModelFit, Interpolations
import GModelFit.prepare!, GModelFit.evaluate!

# Define the component structure and constructor
struct Interpolator &lt;: GModelFit.AbstractComponent
	theory_x::Vector{Float64}
	theory_y::Vector{Float64}
	interp_y::Vector{Float64}  # will contain the interpolated values
	scale::GModelFit.Parameter

	function Interpolator(theory_x, theory_y)
		scale = GModelFit.Parameter(1)
		scale.low = 0                  # ensure scale parameter is positive
		interp_y = Vector{Float64}()   # this will be populated in prepare!()
		return new(theory_x, theory_y, interp_y, scale)
	end
end

# Component preparation: invoked only once to precompute quantities
# and allocate evaluation buffer
function prepare!(comp::Interpolator, domain::AbstractDomain{1})
	# Pre-compute interpolation on the empirical domain
	itp = linear_interpolation(comp.theory_x, comp.theory_y)
	append!(comp.interp_y, itp(coords(domain)))
	return fill(NaN, length(comp.interp_y)) # buffer for evaluations
end

# Component evaluation
function evaluate!(buffer::Vector{Float64}, comp::Interpolator, domain::AbstractDomain{1},
                   scale)
	buffer .= scale .* comp.interp_y
end</code></pre><p>The following code shows how to prepare a <code>Model</code> including the interpolated theoretical model, and to take into account the possible background introduced by the detector used to obtain empirical data:</p><pre><code class="language-julia hljs">dom = Domain(obs_x)
model = Model(dom, :theory =&gt; Interpolator(theory_x, theory_y),
                   :background =&gt; GModelFit.OffsetSlope(1., 0., 0.2),
                   :main =&gt; SumReducer(:theory, :background))
data = Measures(dom, obs_y, 0.2)
best, fitstats = fit(model, data)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">(<span class="sgr32"><span class="sgr1">Components:
</span></span><span class="sgr1"><span class="sgr94">╭</span></span><span class="sgr94">────────────────┬───────────────────────────────────────────┬─────────────┬───────────┬───────────┬───────────┬─────────╮</span>
<span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Component      </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Type                                      </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Eval. count </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Min       </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Max       </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Mean      </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> NaN/Inf </span></span></span><span class="sgr94">│</span>
<span class="sgr94">├────────────────┼───────────────────────────────────────────┼─────────────┼───────────┼───────────┼───────────┼─────────┤</span>
<span class="sgr94">│</span> main           <span class="sgr94">│</span> SumReducer                                <span class="sgr94">│</span> 68          <span class="sgr94">│</span>    0.4323 <span class="sgr94">│</span>     4.278 <span class="sgr94">│</span>     2.361 <span class="sgr94">│</span> 0       <span class="sgr94">│</span>
<span class="sgr94">│</span>  ├─ theory     <span class="sgr94">│</span> Main.Interpolator <span class="sgr94">│</span> 34          <span class="sgr94">│</span>    -1.694 <span class="sgr94">│</span>     1.777 <span class="sgr94">│</span>    0.2349 <span class="sgr94">│</span> 0       <span class="sgr94">│</span>
<span class="sgr94">│</span>  └─ background <span class="sgr94">│</span> OffsetSlope_1D                            <span class="sgr94">│</span> 42          <span class="sgr94">│</span>     1.346 <span class="sgr94">│</span>     2.907 <span class="sgr94">│</span>     2.127 <span class="sgr94">│</span> 0       <span class="sgr94">│</span>
<span class="sgr94">╰────────────────┴───────────────────────────────────────────┴─────────────┴───────────┴───────────┴───────────┴─────────╯</span>

<span class="sgr32"><span class="sgr1">Parameters:
</span></span><span class="sgr1"><span class="sgr94">╭</span></span><span class="sgr94">────────────┬───────────────────────────────────────────┬────────┬───────┬───────────┬───────────┬────────┬───────╮</span>
<span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Component  </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Type                                      </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Param. </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Range </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Value     </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Uncert.   </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Actual </span></span></span><span class="sgr94">│</span><span class="sgr94"><span class="sgr7"><span class="sgr1"> Patch </span></span></span><span class="sgr94">│</span>
<span class="sgr94">├────────────┼───────────────────────────────────────────┼────────┼───────┼───────────┼───────────┼────────┼───────┤</span>
<span class="sgr94">│</span> theory     <span class="sgr94">│</span> Main.Interpolator <span class="sgr94">│</span> scale  <span class="sgr94">│</span> 0:Inf <span class="sgr94">│</span>     2.079 <span class="sgr94">│</span>   0.09647 <span class="sgr94">│</span>        <span class="sgr94">│</span>       <span class="sgr94">│</span>
<span class="sgr94">├────────────┼───────────────────────────────────────────┼────────┼───────┼───────────┼───────────┼────────┼───────┤</span>
<span class="sgr94">│</span> background <span class="sgr94">│</span> OffsetSlope_1D                            <span class="sgr94">│</span> offset <span class="sgr94">│</span>       <span class="sgr94">│</span>     1.263 <span class="sgr94">│</span>    0.1182 <span class="sgr94">│</span>        <span class="sgr94">│</span>       <span class="sgr94">│</span>
<span class="sgr94">│</span><span class="sgr90">            </span><span class="sgr94">│</span><span class="sgr90">                                           </span><span class="sgr94">│</span><span class="sgr90"> x0     </span><span class="sgr94">│</span><span class="sgr90">       </span><span class="sgr94">│</span><span class="sgr90">         0 </span><span class="sgr94">│</span><span class="sgr90">  (FIXED)  </span><span class="sgr94">│</span><span class="sgr90">        </span><span class="sgr94">│</span><span class="sgr90">       </span><span class="sgr94">│</span>
<span class="sgr94">│</span>            <span class="sgr94">│</span>                                           <span class="sgr94">│</span> slope  <span class="sgr94">│</span>       <span class="sgr94">│</span>    0.1656 <span class="sgr94">│</span>   0.01913 <span class="sgr94">│</span>        <span class="sgr94">│</span>       <span class="sgr94">│</span>
<span class="sgr94">╰────────────┴───────────────────────────────────────────┴────────┴───────┴───────────┴───────────┴────────┴───────╯</span>
, <span class="sgr32"><span class="sgr1">Fit results:</span></span><span class="sgr1"> #data: 7, #free pars: 3, red. fit stat.:    0.60105, Status: <span class="sgr32">OK      </span>
)</span></code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../builtincomp/">« Built-in components</a><a class="docs-footer-nextpage" href="../parameter/">Parameter constraints »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.2.1 on <span class="colophon-date" title="Thursday 15 February 2024 00:30">Thursday 15 February 2024</span>. Using Julia version 1.10.0.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
